---
title: "Plot Results"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load library

```{r}
library(tidyverse)
```

Takes list of human genes and look for enrichment in dataset

### EWCE

```{r}
ewce <- function(d,gene_set,name=NULL,number_of_iteration=9999) {
  d <- read_tsv(d) %>% gather(Lvl5,spe_10k,-Gene,-gene_id,-entrez_id)
  
  # Select column with matching names
  n_genes_symbol <- sum(gene_set[[1]]%in%d$Gene)
  n_genes_ensembl <- sum(gene_set[[1]]%in%d$gene_id)
  n_genes_entrez<- sum(gene_set[[1]]%in%d$entrez_id)

  gene_column <- which.max(c(n_genes_symbol,n_genes_ensembl,n_genes_entrez))
  gene_column_name <- colnames(d)[gene_column]
  colnames(gene_set)[1] <- gene_column_name
  proportion <- d %>% filter(!is.na((get(gene_column_name)))) %>% select(gene_column,Lvl5,spe_10k) %>% spread(Lvl5,spe_10k)

  # Add Pathway information to specificity data
  
  colnames(gene_set)[1] <- gene_column_name
  proportion_gene_set <- proportion[proportion[[gene_column_name]]%in%gene_set[[gene_column_name]],]

  cat(c("Number of protein coding genes in dataset",nrow(proportion),"\n"))

  #Print length of gene set
  cat(c("Length of gene set original",nrow(gene_set),"\n"))

  #Print number of genes in the gene set and also with a 1to1 ortholog
  cat(c("Length of gene set with a match in dataset",nrow(proportion_gene_set),"\n"))

  #Average proportion in each cell type
  mean_proportion <- apply(proportion_gene_set[-1],2,mean)

  ######
  #Permutation
  ######

  mean_proportion_bootstrap_df <- matrix(ncol=ncol(proportion_gene_set)-1,nrow=number_of_iteration)
  for (i in 1:number_of_iteration){
    mean_proportion_bootstrap_df[i,] <- apply(proportion[sample(nrow(proportion),nrow(proportion_gene_set),replace=F),][-1],2,mean)
    if(i%%1000==0){
    cat(i)
   cat("\n")
   }
  }

  #Get Pvalue

  pvalues <- vector("numeric", ncol(proportion_gene_set)-1)
  for (i in 1:ncol(mean_proportion_bootstrap_df)){
    number_null_more_extreme <- length(which(mean_proportion_bootstrap_df[,i] >= mean_proportion[i]))
   pvalues[i] <- (number_null_more_extreme+1)/(nrow(mean_proportion_bootstrap_df)+1)
  }
  names(pvalues) <- colnames(proportion_gene_set)[-1]

  #Get Z-score

  sd_boot <- apply(mean_proportion_bootstrap_df,2,sd)
  mean_boot <- apply(mean_proportion_bootstrap_df,2,mean)
  z_scores <- (mean_proportion-mean_boot)/sd_boot

  results <- cbind(pvalues,z_scores) %>% as.data.frame() %>% rownames_to_column(var = "Lvl5")  %>% arrange(pvalues,-z_scores) %>%
   rename(p=pvalues) %>% 
    mutate(fdr=p.adjust(p,method="fdr")) %>%
    mutate(Significance=ifelse(fdr<0.05,"5% FDR", "Not Significant")) %>%
   mutate(Lvl5=factor(Lvl5,levels=rev(Lvl5)))
}
```

### Function for Plotting results

```{r}
plot_ewce_log10P <- function(res,out,width=6,height=10) {
  p <- ggplot(res,aes(Lvl5,-log10(p),fill=Significance)) + geom_col() + coord_flip() + theme_classic() + xlab("")
  ggsave(p,filename=out,width=width,height=height)
}
```

```{r}
plot_ewce_estimate <- function(res,out,width=6,height=10) {
  p <- ggplot(res,aes(Lvl5,z_scores,fill=Significance)) + geom_col() + 
    coord_flip() + theme_classic() + xlab("") + 
    geom_hline(yintercept = 0)
  ggsave(p,filename=out,width=width,height=height)
}
```

### Pathway analysis

### Loading

```{r}
most <- read_tsv("~/Documents/Data/Gene_sets/Shuyang_most_least_conserved/genes_MOST_conserved_exon_191107.txt")
least <- read_tsv("~/Documents/Data/Gene_sets/Shuyang_most_least_conserved/genes_LEAST_conserved_exon_191107.txt")
```

### Create directory for results

#### Skene Lvl1

```{r}
dir.create("../../01_Plots/Skene_lvl1/ShuyangConserved/Ewce/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- ewce("../../02_Processed/Skene_lvl1.1to1.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Skene_lvl1/ShuyangConserved/Ewce/most_conserved.Ewce.txt")
most_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Skene_lvl1/ShuyangConserved/Ewce/most_conserved.Ewce.log10p.pdf")
most_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Skene_lvl1/ShuyangConserved/Ewce/most_conserved.Ewce.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- ewce("../../02_Processed/Skene_lvl1.1to1.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Skene_lvl1/ShuyangConserved/Ewce/least_conserved.Ewce.txt")
least_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Skene_lvl1/ShuyangConserved/Ewce/least_conserved.Ewce.log10p.pdf")
least_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Skene_lvl1/ShuyangConserved/Ewce/least_conserved.Ewce.estimate.pdf")
```

### GTEx v7

```{r}
dir.create("../../01_Plots/GTEx_v7/ShuyangConserved/Ewce/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- ewce("../../02_Processed/GTEx.v7.all.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/GTEx_v7/ShuyangConserved/Ewce/most_conserved.Ewce.txt")
most_conserved %>% plot_ewce_log10P(.,"../../01_Plots/GTEx_v7/ShuyangConserved/Ewce/most_conserved.Ewce.log10p.pdf")
most_conserved %>% plot_ewce_estimate(.,"../../01_Plots/GTEx_v7/ShuyangConserved/Ewce/most_conserved.Ewce.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- ewce("../../02_Processed/GTEx.v7.all.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/GTEx_v7/ShuyangConserved/Ewce/least_conserved.Ewce.txt")
least_conserved %>% plot_ewce_log10P(.,"../../01_Plots/GTEx_v7/ShuyangConserved/Ewce/least_conserved.Ewce.log10p.pdf")
least_conserved %>% plot_ewce_estimate(.,"../../01_Plots/GTEx_v7/ShuyangConserved/Ewce/least_conserved.Ewce.estimate.pdf")
```

### GTEx v8

```{r}
dir.create("../../01_Plots/GTEx_v8/ShuyangConserved/Ewce/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- ewce("../../02_Processed/GTEx.v8.all.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/GTEx_v8/ShuyangConserved/Ewce/most_conserved.Ewce.txt")
most_conserved %>% plot_ewce_log10P(.,"../../01_Plots/GTEx_v8/ShuyangConserved/Ewce/most_conserved.Ewce.log10p.pdf")
most_conserved %>% plot_ewce_estimate(.,"../../01_Plots/GTEx_v8/ShuyangConserved/Ewce/most_conserved.Ewce.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- ewce("../../02_Processed/GTEx.v8.all.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/GTEx_v8/ShuyangConserved/Ewce/least_conserved.Ewce.txt")
least_conserved %>% plot_ewce_log10P(.,"../../01_Plots/GTEx_v8/ShuyangConserved/Ewce/least_conserved.Ewce.log10p.pdf")
least_conserved %>% plot_ewce_estimate(.,"../../01_Plots/GTEx_v8/ShuyangConserved/Ewce/least_conserved.Ewce.estimate.pdf")
```

### Zeisel Level 4

```{r}
dir.create("../../01_Plots/Zeisel_lvl4/ShuyangConserved/Ewce/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- ewce("../../02_Processed/Zeisel.lvl4.1to1.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Zeisel_lvl4/ShuyangConserved/Ewce/most_conserved.Ewce.txt")
most_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Zeisel_lvl4/ShuyangConserved/Ewce/most_conserved.Ewce.log10p.pdf")
most_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Zeisel_lvl4/ShuyangConserved/Ewce/most_conserved.Ewce.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- ewce("../../02_Processed/Zeisel.lvl4.1to1.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Zeisel_lvl4/ShuyangConserved/Ewce/least_conserved.Ewce.txt")
least_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Zeisel_lvl4/ShuyangConserved/Ewce/least_conserved.Ewce.log10p.pdf")
least_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Zeisel_lvl4/ShuyangConserved/Ewce/least_conserved.Ewce.estimate.pdf")
```


### Zeisel Level 5

```{r}
dir.create("../../01_Plots/Zeisel_lvl5/ShuyangConserved/Ewce/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- ewce("../../02_Processed/Zeisel.1to1.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Zeisel_lvl5/ShuyangConserved/Ewce/most_conserved.Ewce.txt")
most_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Zeisel_lvl5/ShuyangConserved/Ewce/most_conserved.Ewce.log10p.pdf",height=30)
most_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Zeisel_lvl5/ShuyangConserved/Ewce/most_conserved.Ewce.estimate.pdf",height=30)
```

### Least Conserved

```{r}
least_conserved <- ewce("../../02_Processed/Zeisel.1to1.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Zeisel_lvl5/ShuyangConserved/Ewce/least_conserved.Ewce.txt")
least_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Zeisel_lvl5/ShuyangConserved/Ewce/least_conserved.Ewce.log10p.pdf",height=30)
least_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Zeisel_lvl5/ShuyangConserved/Ewce/least_conserved.Ewce.estimate.pdf",height=30)
```


### Habib

```{r}
dir.create("../../01_Plots/Habib/ShuyangConserved/Ewce/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- ewce("../../02_Processed/Habib.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Habib/ShuyangConserved/Ewce/most_conserved.Ewce.txt")
most_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Habib/ShuyangConserved/Ewce/most_conserved.Ewce.log10p.pdf")
most_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Habib/ShuyangConserved/Ewce/most_conserved.Ewce.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- ewce("../../02_Processed/Habib.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Habib/ShuyangConserved/Ewce/least_conserved.Ewce.txt")
least_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Habib/ShuyangConserved/Ewce/least_conserved.Ewce.log10p.pdf")
least_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Habib/ShuyangConserved/Ewce/least_conserved.Ewce.estimate.pdf")
```

### Lake

```{r}
dir.create("../../01_Plots/Lake/ShuyangConserved/Ewce/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- ewce("../../02_Processed/Lake.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Lake/ShuyangConserved/Ewce/most_conserved.Ewce.txt")
most_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Lake/ShuyangConserved/Ewce/most_conserved.Ewce.log10p.pdf",height=20)
most_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Lake/ShuyangConserved/Ewce/most_conserved.Ewce.estimate.pdf",height=20)
```

### Least Conserved

```{r}
least_conserved <- ewce("../../02_Processed/Lake.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Lake/ShuyangConserved/Ewce/least_conserved.Ewce.txt")
least_conserved %>% plot_ewce_log10P(.,"../../01_Plots/Lake/ShuyangConserved/Ewce/least_conserved.Ewce.log10p.pdf",height=20)
least_conserved %>% plot_ewce_estimate(.,"../../01_Plots/Lake/ShuyangConserved/Ewce/least_conserved.Ewce.estimate.pdf",height=20)
```