---
title: "GTEx"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Data

```{R, load data,message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
```

### Function for Fisher's exact test

```{r}
reg <- function(d,pathway) {
  d <- read_tsv(d) %>% gather(Lvl5,spe_10k,-Gene,-gene_id,-entrez_id)
  
  # Read pathway file
  pathway <- pathway  %>% 
  mutate(Pathway=1) %>% 
  select(1,Pathway)
  
  # Select column with matching names
  n_genes_symbol <- sum(pathway[[1]]%in%d$Gene)
  n_genes_ensembl <- sum(pathway[[1]]%in%d$gene_id)
  n_genes_entrez<- sum(pathway[[1]]%in%d$entrez_id)

  gene_column <- which.max(c(n_genes_symbol,n_genes_ensembl,n_genes_entrez))
  colnames(pathway)[1] <- colnames(d)[gene_column]
  
  # Add Pathway information to specificity data
  d <- left_join(d,pathway,by=colnames(d)[gene_column])
  d <- mutate(d,Pathway=ifelse(is.na(Pathway),0,1))
  
  d <- d %>% group_by(Lvl5) %>% mutate(spe_10k_z = scale(spe_10k)) %>% filter(Pathway==1)
  
  res <- tidy(lm(spe_10k_z ~0 + Lvl5,data=d)) %>% mutate(term=gsub("Lvl5","",term)) %>%
   rename(p=p.value) %>%
    mutate(p=ifelse(estimate>0,p/2,(1-p/2))) %>%
    mutate(fdr=p.adjust(p,method="fdr")) %>%
    arrange(p) %>%
    mutate(Significance=ifelse(fdr<0.05,"5% FDR", "Not Significant")) %>%
    mutate(Lvl5=factor(term,levels=rev(term)))
}
```

### Function for Plotting results

```{r}
plot_reg_log10P <- function(res,out,width=6,height=10) {
  p <- ggplot(res,aes(Lvl5,-log10(p),fill=Significance)) + geom_col() + coord_flip() + theme_classic() + xlab("")
  ggsave(p,filename=out,width=width,height=height)
}
```

```{r}
plot_reg_estimate <- function(res,out,width=6,height=10) {
  p <- ggplot(res,aes(Lvl5,estimate,col=Significance)) + geom_point() + 
    geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error)) + 
    coord_flip() + theme_classic() + xlab("") + 
    geom_hline(yintercept = 0)
  ggsave(p,filename=out,width=width,height=height)
}
```

### Pathway analysis

### Loading

```{r}
most <- read_tsv("~/Documents/Data/Gene_sets/Shuyang_most_least_conserved/genes_MOST_conserved_exon_191107.txt")
least <- read_tsv("~/Documents/Data/Gene_sets/Shuyang_most_least_conserved/genes_LEAST_conserved_exon_191107.txt")
```

# GTEx v7

### Create directory for results

```{r}
dir.create("../../01_Plots/GTEx_v7/ShuyangConserved/Reg/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- reg("../../02_Processed/GTEx.v7.all.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/GTEx_v7/ShuyangConserved/Reg/most_conserved.Reg.txt")
most_conserved %>% plot_reg_log10P(.,"../../01_Plots/GTEx_v7/ShuyangConserved/Reg/most_conserved.Reg.log10p.pdf")
most_conserved %>% plot_reg_estimate(.,"../../01_Plots/GTEx_v7/ShuyangConserved/Reg/most_conserved.fisher.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- reg("../../02_Processed/GTEx.v7.all.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/GTEx_v7/ShuyangConserved/Reg/least_conserved.Reg.txt")
least_conserved %>% plot_reg_log10P(.,"../../01_Plots/GTEx_v7/ShuyangConserved/Reg/least_conserved.Reg.log10p.pdf")
least_conserved %>% plot_reg_estimate(.,"../../01_Plots/GTEx_v7/ShuyangConserved/Reg/least_conserved.Reg.estimate.pdf")
```

# GTEx v8

### Create directory for results

```{r}
dir.create("../../01_Plots/GTEx_v8/ShuyangConserved/Reg/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- reg("../../02_Processed/GTEx.v8.all.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/GTEx_v8/ShuyangConserved/Reg/most_conserved.Reg.txt")
most_conserved %>% plot_reg_log10P(.,"../../01_Plots/GTEx_v8/ShuyangConserved/Reg/most_conserved.Reg.log10p.pdf")
most_conserved %>% plot_reg_estimate(.,"../../01_Plots/GTEx_v8/ShuyangConserved/Reg/most_conserved.fisher.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- reg("../../02_Processed/GTEx.v8.all.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/GTEx_v8/ShuyangConserved/Reg/least_conserved.Reg.txt")
least_conserved %>% plot_reg_log10P(.,"../../01_Plots/GTEx_v8/ShuyangConserved/Reg/least_conserved.Reg.log10p.pdf")
least_conserved %>% plot_reg_estimate(.,"../../01_Plots/GTEx_v8/ShuyangConserved/Reg/least_conserved.Reg.estimate.pdf")
```

# Skene Level 1

### Create directory for results

```{r}
dir.create("../../01_Plots/Skene_lvl1/ShuyangConserved/Reg/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- reg("../../02_Processed/Skene_lvl1.1to1.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Skene_lvl1/ShuyangConserved/Reg/most_conserved.Reg.txt")
most_conserved %>% plot_reg_log10P(.,"../../01_Plots/Skene_lvl1/ShuyangConserved/Reg/most_conserved.Reg.log10p.pdf")
most_conserved %>% plot_reg_estimate(.,"../../01_Plots/Skene_lvl1/ShuyangConserved/Reg/most_conserved.fisher.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- reg("../../02_Processed/Skene_lvl1.1to1.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Skene_lvl1/ShuyangConserved/Reg/least_conserved.Reg.txt")
least_conserved %>% plot_reg_log10P(.,"../../01_Plots/Skene_lvl1/ShuyangConserved/Reg/least_conserved.Reg.log10p.pdf")
least_conserved %>% plot_reg_estimate(.,"../../01_Plots/Skene_lvl1/ShuyangConserved/Reg/least_conserved.Reg.estimate.pdf")
```

# Zeisel Level 4

### Create directory for results

```{r}
dir.create("../../01_Plots/Zeisel_lvl4/ShuyangConserved/Reg/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- reg("../../02_Processed/Zeisel.lvl4.1to1.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Zeisel_lvl4/ShuyangConserved/Reg/most_conserved.Reg.txt")
most_conserved %>% plot_reg_log10P(.,"../../01_Plots/Zeisel_lvl4/ShuyangConserved/Reg/most_conserved.Reg.log10p.pdf")
most_conserved %>% plot_reg_estimate(.,"../../01_Plots/Zeisel_lvl4/ShuyangConserved/Reg/most_conserved.fisher.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- reg("../../02_Processed/Zeisel.lvl4.1to1.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Zeisel_lvl4/ShuyangConserved/Reg/least_conserved.Reg.txt")
least_conserved %>% plot_reg_log10P(.,"../../01_Plots/Zeisel_lvl4/ShuyangConserved/Reg/least_conserved.Reg.log10p.pdf")
least_conserved %>% plot_reg_estimate(.,"../../01_Plots/Zeisel_lvl4/ShuyangConserved/Reg/least_conserved.Reg.estimate.pdf")
```

# Zeisel Level 5

### Create directory for results

```{r}
dir.create("../../01_Plots/Zeisel_lvl5/ShuyangConserved/Reg/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- reg("../../02_Processed/Zeisel.1to1.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Zeisel_lvl5/ShuyangConserved/Reg/most_conserved.Reg.txt")
most_conserved %>% plot_reg_log10P(.,"../../01_Plots/Zeisel_lvl5/ShuyangConserved/Reg/most_conserved.Reg.log10p.pdf",height=30)
most_conserved %>% plot_reg_estimate(.,"../../01_Plots/Zeisel_lvl5/ShuyangConserved/Reg/most_conserved.fisher.estimate.pdf",height=30)
```

### Least Conserved

```{r}
least_conserved <- reg("../../02_Processed/Zeisel.1to1.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Zeisel_lvl5/ShuyangConserved/Reg/least_conserved.Reg.txt")
least_conserved %>% plot_reg_log10P(.,"../../01_Plots/Zeisel_lvl5/ShuyangConserved/Reg/least_conserved.Reg.log10p.pdf",height=30)
least_conserved %>% plot_reg_estimate(.,"../../01_Plots/Zeisel_lvl5/ShuyangConserved/Reg/least_conserved.Reg.estimate.pdf",height=30)
```

# Habib

### Create directory for results

```{r}
dir.create("../../01_Plots/Habib/ShuyangConserved/Reg/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- reg("../../02_Processed/Habib.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Habib/ShuyangConserved/Reg/most_conserved.Reg.txt")
most_conserved %>% plot_reg_log10P(.,"../../01_Plots/Habib/ShuyangConserved/Reg/most_conserved.Reg.log10p.pdf")
most_conserved %>% plot_reg_estimate(.,"../../01_Plots/Habib/ShuyangConserved/Reg/most_conserved.fisher.estimate.pdf")
```

### Least Conserved

```{r}
least_conserved <- reg("../../02_Processed/Habib.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Habib/ShuyangConserved/Reg/least_conserved.Reg.txt")
least_conserved %>% plot_reg_log10P(.,"../../01_Plots/Habib/ShuyangConserved/Reg/least_conserved.Reg.log10p.pdf")
least_conserved %>% plot_reg_estimate(.,"../../01_Plots/Habib/ShuyangConserved/Reg/least_conserved.Reg.estimate.pdf")
```

# Lake

### Create directory for results

```{r}
dir.create("../../01_Plots/Lake/ShuyangConserved/Reg/",recursive = TRUE,showWarnings = FALSE)
```

### Most Conserved

```{r}
most_conserved <- reg("../../02_Processed/Lake.norm.txt.gz",most)
most_conserved %>% write_tsv("../../01_Plots/Lake/ShuyangConserved/Reg/most_conserved.Reg.txt")
most_conserved %>% plot_reg_log10P(.,"../../01_Plots/Lake/ShuyangConserved/Reg/most_conserved.Reg.log10p.pdf",height=20)
most_conserved %>% plot_reg_estimate(.,"../../01_Plots/Lake/ShuyangConserved/Reg/most_conserved.fisher.estimate.pdf",height=20)
```

### Least Conserved

```{r}
least_conserved <- reg("../../02_Processed/Lake.norm.txt.gz",least)
least_conserved %>% write_tsv("../../01_Plots/Lake/ShuyangConserved/Reg/least_conserved.Reg.txt")
least_conserved %>% plot_reg_log10P(.,"../../01_Plots/Lake/ShuyangConserved/Reg/least_conserved.Reg.log10p.pdf",height=20)
least_conserved %>% plot_reg_estimate(.,"../../01_Plots/Lake/ShuyangConserved/Reg/least_conserved.Reg.estimate.pdf",height=20)
```