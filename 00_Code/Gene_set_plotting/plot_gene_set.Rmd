---
title: "gene_set_expression_check"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(tidytext)
library(patchwork)
theme_set(theme_light())
```

```{r}
skene <- "../../02_Processed/Skene_lvl1.1to1.norm.txt.gz"
dskene_lvl2 <- "../../02_Processed/Skene_lvl2.1to1.norm.txt.gz"
zeisel <- "../../02_Processed/Zeisel.1to1.norm.txt.gz"
zeisel_lvl4 <- "../../02_Processed/Zeisel.lvl4.1to1.norm.txt.gz"
habib <- "../../02_Processed/Habib.norm.txt.gz"
lake <- "../../02_Processed/Lake.norm.txt.gz"
```

# Functions

```{r}
plot_gene_set_scaled10k_top_n <- function(d,gene_set,n){
    
    d <- read_tsv(d)
  
    # Select column with matching names
    n_genes_symbol <- sum(gene_set[[1]]%in%d$Gene)
    n_genes_ensembl <- sum(gene_set[[1]]%in%d$gene_id)
    n_genes_entrez<- sum(gene_set[[1]]%in%d$entrez_id)

    gene_column <- which.max(c(n_genes_symbol,n_genes_ensembl,n_genes_entrez))
    gene_column_name <- colnames(d)[gene_column]

    filter(d,(get(gene_column_name))%in%gene_set[[1]]) %>% 
    group_by(get(gene_column_name)) %>% 
    mutate(rank=rank(-Expr_sum_mean_scaled10k,ties.method="random")) %>% 
    filter(rank <=n) %>%
    ungroup() %>%
    #mutate(geneName=factor(geneName,levels=gene_set) %>%
    mutate(Lvl5=reorder_within(Lvl5,Expr_sum_mean_scaled10k,get(gene_column_name))) %>% 
    ggplot(.,aes(Lvl5,Expr_sum_mean_scaled10k,fill=get(gene_column_name))) + geom_col() + 
    coord_flip() + 
    theme(legend.position = "none") + xlab("") + ylab("Expression (scaled 10k)") + 
    facet_wrap(~get(gene_column_name),scales = "free") +
    scale_x_reordered() 
}
```

# Gene sets

```{r}
gene_set_test <- c("APOE","DRD2","CACNA1C","C4A")
gene_set_coloc_all <- read_tsv("~/Documents/Data/Gene_sets/CMC_conditional_analysis/colocCMC_published.txt")
gene_set_coloc <- read_tsv("~/Documents/Data/Gene_sets/CMC_conditional_analysis/colocCMC_published_gene_parsed.txt",col_names = FALSE)
gene_set_exome <- readxl::read_xlsx("~/Documents/Data/Gene_sets/SCZ_exome_seq/schema scz exome sig genes.xlsx")
tada65 <- read_tsv("/Users/julienbryios/Documents/Data/Gene_sets/Autism_genes2/asd.tada65.txt")
ap <- read_tsv("/Users/julienbryios/Documents/Data/Gene_sets/Antipsychotic_targets/antipsychotic.txt",skip=4,col_names=FALSE)
syngoBP <- read_tsv("/Users/julienbryios/Documents/Data/Gene_sets/SynGO/SynGO_genesets_v1.0_2018-07-31/Processed/SYNGO.BP.10genes.min.binary.hgnc.txt")
park_info  <- read_tsv("~/Documents/Data/Gene_sets/Parkinson_Klein_2012/table.txt") %>% filter(grepl("Confirmed",Status.and.remarks),Gene!="Unknown") 
park <- c("SNCA","PRKN","PARK7","PINK1","LRRK2","ATP13A2","PLA2G6","FBX07","VPS35")
park2 <- read_tsv("~/Documents/Data/Projects/Best_tissue2/Paper/Nature_Genetics_submission/v10/Tables/TableS12.txt") %>% rename(Parkinsonism = `Parkinsonism associated genes (Source:`)
```

# Plots

## Skene lvl 1

### SCZ Coloc

Paper: Landscape of Conditional eQTL in Dorsolateral Prefrontal Cortex and Co-localization with Schizophrenia GWAS

```{r}
dir.create("../../01_Plots/Skene_lvl1/SCZ_coloc/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(skene,gene_set_coloc,n=15)
ggsave(p,filename = "../../01_Plots/Skene_lvl1/SCZ_coloc/coloc_CMC_conditional_scaled10k.pdf.topn.pdf", width = 24,height=20)
```

### SCZ Exome   

```{r}
dir.create("../../01_Plots/Skene_lvl1/SCZ_exome/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(skene,gene_set_exome,n=15)
ggsave(p,filename = "../../01_Plots/Skene_lvl1/SCZ_exome/SCZ_exome_scaled10k.top15.pdf", width = 12,height=10)
```

### Autism TADA 65   

```{r}
dir.create("../../01_Plots/Skene_lvl1/Autism_tada65/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(skene,tada65,n=15)
ggsave(p,filename = "../../01_Plots/Skene_lvl1/Autism_tada65/Autism_tada65_scaled10k.top15.pdf", width = 30,height=22)
```

### Antipsychotics

```{r}
dir.create("../../01_Plots/Skene_lvl1/Antipsychotics/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(skene,ap,15)
ggsave(p,filename = "../../01_Plots/Skene_lvl1/Antipsychotics/Antipsychotics_tada65_scaled10k.top15.pdf", width = 40,height=20)
```

### SYNGO postsynaptic strucutral constituent

```{r}
syngo_postsynapse_struct <- as.data.frame(syngoBP$ENTREZ[ifelse(syngoBP$`structural constituent of postsynapse (GO:0099186)`==1,TRUE,FALSE)])
dir.create("../../01_Plots/Skene_lvl1/SYNGO_postsynapse_struct/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(skene,syngo_postsynapse_struct,n=15)
ggsave(p,filename = "../../01_Plots/Skene_lvl1/SYNGO_postsynapse_struct/SYNGO_postsynapse_struct_scaled10k.top15.pdf", width = 24,height=18)
```

### Parkinson Klein 2012

```{r}
dir.create("../../01_Plots/Skene_lvl1/Parkinson_Klein/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(skene,park,n=15)
ggsave(p,filename = "../../01_Plots/Skene_lvl1/Parkinson_Klein/Parkinson_Klein_scaled10k.top15.pdf", width = 12,height=9)
```

### Parkinsonism

```{r}
dir.create("../../01_Plots/Skene_lvl1/Parkinsonism/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(skene,park2,n=15)
ggsave(p,filename = "../../01_Plots/Skene_lvl1/Parkinsonism/Parkinsonism_scaled10k.top15.pdf", width = 40,height=20)
```

## Zeisel Lvl4

### SCZ Coloc

Paper: Landscape of Conditional eQTL in Dorsolateral Prefrontal Cortex and Co-localization with Schizophrenia GWAS

```{r}
dir.create("../../01_Plots/Zeisel_lvl4/SCZ_coloc/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel_lvl4,gene_set_coloc,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl4/SCZ_coloc/coloc_CMC_conditional_scaled10k.pdf.topn.pdf", width = 24,height=20)
```

### SCZ Exome   

```{r}
dir.create("../../01_Plots/Zeisel_lvl4/SCZ_exome/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel_lvl4,gene_set_exome,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl4/SCZ_exome/SCZ_exome_scaled10k.top15.pdf", width = 12,height=10)
```

### Autism TADA 65   

```{r}
dir.create("../../01_Plots/Zeisel_lvl4/Autism_tada65/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel_lvl4,tada65,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl4/Autism_tada65/Autism_tada65_scaled10k.top15.pdf", width = 30,height=22)
```

### Antipsychotics

```{r}
dir.create("../../01_Plots/Zeisel_lvl4/Antipsychotics/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel_lvl4,ap,15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl4/Antipsychotics/Antipsychotics_tada65_scaled10k.top15.pdf", width = 40,height=20)
```

### SYNGO postsynaptic strucutral constituent

```{r}
syngo_postsynapse_struct <- as.data.frame(syngoBP$ENTREZ[ifelse(syngoBP$`structural constituent of postsynapse (GO:0099186)`==1,TRUE,FALSE)])
dir.create("../../01_Plots/Zeisel_lvl4/SYNGO_postsynapse_struct/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel_lvl4,syngo_postsynapse_struct,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl4/SYNGO_postsynapse_struct/SYNGO_postsynapse_struct_scaled10k.top15.pdf", width = 24,height=18)
```

### Parkinson Klein 2012

```{r}
dir.create("../../01_Plots/Zeisel_lvl4/Parkinson_Klein/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel_lvl4,park,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl4/Parkinson_Klein/Parkinson_Klein_scaled10k.top15.pdf", width = 12,height=9)
```

### Parkinsonism

```{r}
dir.create("../../01_Plots/Zeisel_lvl4/Parkinsonism/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel_lvl4,park2,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl4/Parkinsonism/Parkinsonism_scaled10k.top15.pdf", width = 40,height=20)
```

## Zeisel Lvl5

### SCZ Coloc

Paper: Landscape of Conditional eQTL in Dorsolateral Prefrontal Cortex and Co-localization with Schizophrenia GWAS

```{r}
dir.create("../../01_Plots/Zeisel_lvl5/SCZ_coloc/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel,gene_set_coloc,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl5/SCZ_coloc/coloc_CMC_conditional_scaled10k.pdf.topn.pdf", width = 24,height=20)
```

### SCZ Exome   

```{r}
dir.create("../../01_Plots/Zeisel_lvl5/SCZ_exome/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel,gene_set_exome,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl5/SCZ_exome/SCZ_exome_scaled10k.top15.pdf", width = 12,height=10)
```

### Autism TADA 65   

```{r}
dir.create("../../01_Plots/Zeisel_lvl5/Autism_tada65/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel,tada65,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl5/Autism_tada65/Autism_tada65_scaled10k.top15.pdf", width = 30,height=22)
```

### Antipsychotics

```{r}
dir.create("../../01_Plots/Zeisel_lvl5/Antipsychotics/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel,ap,15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl5/Antipsychotics/Antipsychotics_tada65_scaled10k.top15.pdf", width = 40,height=20)
```

### SYNGO postsynaptic strucutral constituent

```{r}
syngo_postsynapse_struct <- as.data.frame(syngoBP$ENTREZ[ifelse(syngoBP$`structural constituent of postsynapse (GO:0099186)`==1,TRUE,FALSE)])
dir.create("../../01_Plots/Zeisel_lvl5/SYNGO_postsynapse_struct/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel,syngo_postsynapse_struct,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl5/SYNGO_postsynapse_struct/SYNGO_postsynapse_struct_scaled10k.top15.pdf", width = 24,height=18)
```

### Parkinson Klein 2012

```{r}
dir.create("../../01_Plots/Zeisel_lvl5/Parkinson_Klein/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel,park,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl5/Parkinson_Klein/Parkinson_Klein_scaled10k.top15.pdf", width = 12,height=9)
```

### Parkinsonism

```{r}
dir.create("../../01_Plots/Zeisel_lvl5/Parkinsonism/",showWarnings = FALSE,recursive = TRUE)
p <- plot_gene_set_scaled10k_top_n(zeisel,park2,n=15)
ggsave(p,filename = "../../01_Plots/Zeisel_lvl5/Parkinsonism/Parkinsonism_scaled10k.top15.pdf", width = 40,height=20)
```